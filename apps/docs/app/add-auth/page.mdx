# Add Authentication to Your Agent

## Why Authentication Matters

Your agent currently works great with public tools, but has a critical limitation: **it doesn't know who you are**. Without user identity, your agent can't:

- Access personalized data (like your portfolio)
- Make user-specific decisions
- Maintain secure boundaries between users
- Provide truly personalized AI experiences

In this step, we'll solve this by adding Auth0 authentication, transforming your anonymous chatbot into a **personalized AI agent** that knows who it's helping.

## What we're building in this step

<Mermaid chart={`
sequenceDiagram
    participant User as üë§ User
    participant Agent as ü§ñ AI Agent<br/>:3003
    participant Auth0 as üîê Auth0 Tenant
    participant API as üìä Stock API<br/>:3001
    
    User->>Agent: Visit http://localhost:3003
    Agent->>Agent: Middleware check: No session
    Agent->>Auth0: Redirect to /auth/login
    Auth0->>User: Show login form
    User->>Auth0: Enter credentials
    Auth0->>Agent: Callback with tokens
    Agent->>Agent: Store session
    Agent->>User: Show authenticated chat
    
    Note over Agent: Defense in depth:
    Note over Agent: Middleware + Page + API protection
    
    User->>Agent: "What's WAYNE stock price?"
    Agent->>API: getStockPrice('WAYNE')
    API->>Agent: $150.25
    Agent->>User: "WAYNE is $150.25"
`} />

**Security layers we're adding:**
- ‚úÖ **Middleware protection** - Auth0 redirects for all routes
- ‚úÖ **Server-side page protection** - `withPageAuthRequired()`
- ‚úÖ **API route protection** - Session verification in chat endpoint
- üîÑ **Next:** Add portfolio tools with token delegation

---

## Create your Auth0 tenant

First, create your own Auth0 tenant for authentication:

Go to **<ExternalLink href="https://auth0.ai">https://auth0.ai</ExternalLink>** 


1. **Click "Get Started"** and then complete the signup process

    ![Auth0 Landing](/auth0-landing.png)

2. Select a region and approve the "Terms and Conditions" for GenAI Developer Preview 

    ![Auth0 Tenant Creation](/auth0-add-locality.png)

3. Click *Continue* button, the tenant name will be automatically generated for

    ![Auth0 Dashboard](/auth0-tenant-with-highlight.png)

4. **Note your tenant domain** - You'll need this (e.g., `genai-9199191919199191.us.auth0.com`)


## Set up Auth0 CLI and initialize your tenant

Configure the Auth0 CLI and run the initialization script:

```bash
# Login to Auth0 CLI
auth0 login --scopes create:client_grants

# Select your newly created tenant when prompted
# Navigate to agent directory and run init script
cd auth0-agent
./init.sh
```

**What the init script does:**

- ‚úÖ **Creates Management Client** - Auth0 client for Terraform
- ‚úÖ **Runs Terraform** - Sets up API resource and agent application  
- ‚úÖ **Generates Environment** - Creates `apps/agent/.env` file

## Set up enterprise connection (for sign-in)

Since we're building an Agent that plugs into the existing Demo Trade Pro ecosystem, we'll leverage the identity provider that already secures its web and API layers.

Visit the hosted Stock Web App at <PlatformLink type="app" path="/developer">Developer Platform</PlatformLink> and:

  1. **Enter your tenant domain** (e.g., `genai-9199191919199191.us.auth0.com`)
  2. **Click "Generate OIDC Configuration"**

This will generate a set of credentials that grant access to the DemoTradePro API, and allow your agent to authenticate with DemoTradePro's Identity Provider.

At this point we need to connect the DemoTradePro to our Auth0 Tenant, we will do that by using <ExternalLink href="https://auth0.com/docs/secure/identity-providers/enterprise-connections/openid-connect">OpenID Connect</ExternalLink>. In Auth0 Identity Providers, are known as Connections, to add DemoTradePro as an OpenID Connect Identity Provider, you have two options, either set up manually via dashboard, or use the terraform automation.

<Tabs defaultValue="manual" className="w-full">
  <TabsList className="grid w-full grid-cols-2">
    <TabsTrigger value="manual">Manual Configuration</TabsTrigger>
    <TabsTrigger value="developer-tool">Terraform</TabsTrigger>
  </TabsList>
  
  <TabsContent value="developer-tool" className="space-y-4">
    1. **Copy the generated `terraform.tfvars` content** 
    2. **Add it to your `auth0-agent/terraform/terraform.tfvars` file**
    3. **Run the connection script:**

    ```bash
    cd auth0-agent
    ./add-oidc-connection.sh
    ```

    **Note:** At the time of this writing, our Terraform scripts do not yet support two steps around enabling Token Vault grants for your **StockTrade** application and your **_demotradepro-oidc_** OIDC connection, which you can apply manually in the Auth0 Dashboard after Terraform scripts have completed by doing the following:
    1. Navigate to **Applications -> Applications** and select your **StockTrade** Regular Web application. Open the **Settings** tab and scroll to the bottom of the page to the **Advanced Settings**. Open the expander and select the **Grant Types** tab. Here you can enable the **Token Vault** and **Client Initiated Backchannel Authentication** grant types for your application.
    2. Navigate to **Authentication -> Enterprise** and select **OpenID Connect**. Next select your **demotradepro-oidc** connection open the **Settings** tab. Scroll to the bottom and the **Advanced** section. Here you can ensure that Token Vault is enabled for the connection by enabling the **Enable Token Vault** toggle.  
  </TabsContent>
  
  <TabsContent value="manual" className="space-y-4">
    Configure the enterprise connection manually in your Auth0 Dashboard:

    1. Go to **Authentication > Enterprise > OpenID Connect**
       ![Auth0 Enterprise Connections](/images/enterprise-connection.png)
    2. Create a new OIDC connection pointing to the hosted DemoTradePro tenant, name it "demo-trade-pro", and paste the url <PlatformLink type="auth" path="/.well-known/openid-configuration">here</PlatformLink>
       ![Auth0 Enterprise Connections](/images/new-oidc-connection.png)
    3. Copy Paste the ClientID and Client Secret you obtained from the Developer section of the Demo Trade Pro Platform (see [Demo Trade Pro Create OAuth OIDC Client page](https://workshop-trade-app.auth101.dev/developer) if you haven't already).
       ![Auth0 Enterprise Connections](/images/oidc-connection-filled.png)
    4. Scroll down and click "Create"
  </TabsContent>
</Tabs>

## Install NextJS Auth0 SDK

Install the Auth0 NextJS SDK (version 4.9.0 or higher):

```bash
cd apps/agent
pnpm add @auth0/nextjs-auth0@^4.9.0
```

---

## Set up Auth0 client configuration

Now we need to setup the Auth0 SDK Integration in the Agent App itself.

**Create `lib/auth0.ts`:**

```typescript
import { Auth0Client } from "@auth0/nextjs-auth0/server";

// Server-side agent Auth0 client instance
export const auth0 = new Auth0Client({
  logoutStrategy: "oidc",
  authorizationParameters: {
    audience: process.env.AUTH0_AUDIENCE,
    scope: process.env.API_DEFAULT_SCOPES,
    prompt: "login",
    connection: process.env.API_OIDC_CONNECTION_NAME,
  },
});
```

**What this does:**
- **Server-side client** - Handles authentication on the backend
- **Scope configuration** - Defines what permissions to request
- **Environment variables** - Auth0 will read the environment variables setup by the init script in `apps/agent/.env`

---

## Set up authentication middleware

Create middleware to protect all routes and adds the Auth0 route handlers such as /auth/login and /auth/logout.

**Create `middleware.ts` in the root of your agent app:**

```typescript
import type { NextRequest } from "next/server";
import { auth0 } from "./lib/auth0";

export async function middleware(request: NextRequest) {
  // Let Auth0 middleware handle authentication
  return await auth0.middleware(request);
}

export const config = {
  matcher: [
    /*
     * Protect ALL routes including root "/" - redirect to Auth0 login if not authenticated
     * Exclude only:
     * - _next/static (static files)
     * - _next/image (image optimization files) 
     * - favicon.ico, sitemap.xml, robots.txt (metadata files)
     */
    "/((?!_next/static|_next/image|favicon.ico|sitemap.xml|robots.txt).*)"
  ]
};
```

**What this does:**
- **Route protection** - Automatically protects all pages in your app
- **Static file exceptions** - Allows Next.js assets to load without auth
- **Defense in depth** - Works alongside page and API route protection

---

## Enable authentication in your page

Your template agent currently bypasses authentication. Let's enable it!

**Update `app/page.tsx` to use real authentication:**

```typescript
import { auth0 } from "../lib/auth0";
import ChatClient from './components/chat-client';

export default auth0.withPageAuthRequired(
  async function Chat() {
    const session = await auth0.getSession();
    const user = session?.user;

    return <ChatClient user={user} />;
  },
  { returnTo: "/" }
);
```

**What this does:**
- **Server-side auth check** - Verifies user is authenticated before page renders
- **Automatic redirect** - Sends unauthenticated users to Auth0 login
- **Clean and simple** - Just wrap your existing component!

---

## Update your API route to use authentication

Your agent's API route needs to verify user identity. **Replace the entire contents of `app/api/chat/route.ts` with:**

```typescript
import { openai } from '@ai-sdk/openai';
import { streamText, UIMessage, convertToModelMessages, stepCountIs } from 'ai';
import { auth0 } from '../../../lib/auth0';
import { NextResponse } from 'next/server';
import { agentTools } from './tools';

// Allow streaming responses up to 30 seconds
export const maxDuration = 30;

export async function POST(req: Request) {
  // Verify user is authenticated
  const session = await auth0.getSession();
  if (!session || !session.user) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
  }

  const { messages }: { messages: UIMessage[] } = await req.json();
  const user = session.user;

  const result = streamText({
    model: openai('gpt-4o'),
    messages: convertToModelMessages(messages),
    system: `You are a helpful stock trading assistant for DemoTradePro. You provide trading advice, market insights, and help users understand stock market concepts. You are knowledgeable, professional, and always emphasize risk management.

You are currently assisting ${user.name || 'a user'} (${user.email || 'authenticated user'}).

Key guidelines:
- Always remind users that trading involves risk
- Provide educational information about stocks and markets
- Help with basic trading concepts and strategies
- Be conversational and helpful
- Never provide specific financial advice or guarantees
- You can reference the user by their name when appropriate

You now have access to real-time stock market data through your tools. Use them when users ask about stock prices, company information, or want to search for stocks.`,
    tools: agentTools,
    stopWhen: stepCountIs(15),
  });

  return result.toUIMessageStreamResponse();
}
```

**Key changes:**
- **Authentication check** - Verifies user session before processing
- **Personalized system prompt** - AI knows the user's name and email
- **Tools included** - Your public stock tools still work!
- **401 Unauthorized** - Clear error response for invalid sessions

---

## Test your authenticated agent

Visit <ExternalLink showFavicon={false} href="http://localhost:3003">http://localhost:3003</ExternalLink>

1. **Automatic redirect** to Auth0 login
2. **After login** - redirected back to chat
3. **Test stock tools:** "Who am I?"
4. **Personalized response** - AI should greet you by name!

---

## üéØ What's Next?

**You now have:** Fully secured AI agent with complete authentication!

**Security Achievement:**
- üîí **Defense in depth** - Middleware + page + API protection
- üë§ **User identity** - AI knows who you are and personalizes responses
- üö´ **Zero unauthorized access** - Every entry point requires Auth0 authentication

**But there's a problem:** How does your agent access *your* portfolio data from the API?
