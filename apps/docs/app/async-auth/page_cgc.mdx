# Keep Humans in the Loop

*With great power comes great responsibility* â€“ we don't want to let AI Agents make risky decisions without human supervision. In some scenarios, we need to ensure the Agent keeps humans in the loop before taking action.

## What we're building in this step

<Mermaid chart={`
sequenceDiagram
    participant User as ğŸ‘¤ User (Alice)
    participant UserPhone as ğŸ“± User's Phone <br /> (Alice\'s Phone)
    participant Agent as ğŸ¤– Agent <br/>:3003
    participant AgentTenant as ğŸ” Auth0 Tenant <br />  (Agent Tenant)
    participant Root as ğŸ¦ Root Tenant<br/>(DemoTradePro)
    participant API as ğŸ“Š Stock API<br/>:3001
    participant DB as ğŸ—„ï¸ Database
    
    User->>Agent: "Buy 10 WAYNE shares"
    Agent->>Agent: Extract user session
    Agent->>AgentTenant: Ask user's approval
    AgentTenant->>UserPhone: Send approval request
    User->>UserPhone: Approve request
    UserPhone->>AgentTenant: Resolve challenge
    AgentTenant->>Agent: Approval confirmed <br />(Access Token with approved details)
    Agent->>AgentTenant: getAccessTokenForConnection()<br/>(exchange async authorized access token)
    AgentTenant->>Root: Token exchange request<br/>(using OIDC connection)
    Root->>Root: Validate + generate<br/>API access token
    Root->>AgentTenant: Scoped access token<br/>(auto-refresh enabled)
    AgentTenant->>Agent: Fresh API token<br/>(cached + auto-renewed)
    Agent->>API: createOrder()<br/>with delegated token
    API->>API: Validate JWT + extract userId
    API->>DB: INSERT INTO Orders<br/>SET userId = 'alice', symbol = 'WAYNE', shares = 10
    DB->>API: Order ID
    API->>Agent: Order response
    Agent->>User: "You now own 10 more WAYNE shares..."
    
    Note over Root: Root tenant protects<br/>API with real user context
`} />

**Secure Auth0 Async Auth flow we're adding:**
- âœ… **Async Auth** - Request user's approval via Client Initiated Backchannel Authentication (<ExternalLink href="https://auth0.com/docs/get-started/authentication-and-authorization-flow/client-initiated-backchannel-authentication-flow">Auth0 docs</ExternalLink>)
- âœ… **Token Vault** - Exchange async authorized access tokens by federated access tokens (<ExternalLink href="https://auth0.com/docs/secure/tokens/token-vault/call-apis-with-token-vault">Auth0 docs</ExternalLink>)
- âœ… **Create Order Tool** - Enable `createOrder` handling user approval requests

---

## Enroll in Auth0 MFA

First, enable MFA in your tenant.

Open your Auth0 Manage Dashboard:

1. Go to **Security** > **Multi-factor Auth**.
2. Click **Push Notifications using Auth0 Guardian**.
3. Enable the factor, leave **Auth0 Guardian** as the Push Notification App. 
![Enable Auth0 MFA](/images/enable-mfa.png)


Ensure your user is enrolled for MFA:

1. Go to **User Management** > **Users**.
2. Find the user account you used to sign in the Agent chatbot app, open its details page.
3. Scroll down to the **Multi-Factor Authentication** section.
![Send Enrollment Invitation](/images/send-enrollment-invitation.png)
4. Click **Send and enrollment email** to receive an enrollment email.
5. Follow the instructions in the email to set up MFA using the Guardian App.

---

## Add Auth0 Async Auth helper
